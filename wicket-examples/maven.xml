<project xmlns:j="jelly:core" xmlns:u="jelly:util" xmlns:ant="jelly:ant" xmlns:maven="jelly:maven">

	<!--
		Disable the src distribution generation, as source files are
		included the single file distribution, together with the binary
		distribution.
	 -->
	<goal name="dist:prepare-src-filesystem" />
	<goal name="dist:build-src" />

    <preGoal name="xdoc:transform">
    	<!-- create custom dependencies  -->
    	<j:include uri="file:src/xdocs/dependencies.xml" />    	
    </preGoal>
    <postGoal name="xdoc:jelly-transform" >
        <ant:delete>
            <fileset dir="${maven.build.dir}/docs/style" includes="**/maven*.css"/>
        </ant:delete>
	</postGoal>

	<preGoal name="dist:prepare-bin-filesystem">
    	<attainGoal name="war:war" />
    </preGoal>

	<postGoal name="dist:prepare-bin-filesystem">
		<ant:delete>
			<fileset dir="${maven.dist.bin.assembly.dir}" includes="*.jar" />
		</ant:delete>
		<ant:copy file="${maven.build.dir}/${maven.war.final.name}" todir="${maven.dist.bin.assembly.dir}" />
	    <ant:mkdir dir="${maven.dist.bin.assembly.dir}/lib" />

		<j:forEach var="lib" items="${pom.artifacts}">
			<j:set var="dep" value="${lib.dependency}" />
			<j:if test="${dep.type=='jar'}">
	            <j:choose>
	                <j:when test="${dep.getProperty('endorsed')}">
	                    <ant:copy todir="${maven.dist.bin.assembly.dir}/lib/endorsed" file="${lib.path}" />
	                </j:when>
	                <j:otherwise>
	                    <ant:copy todir="${maven.dist.bin.assembly.dir}/lib" file="${lib.path}" />
	                </j:otherwise>
	            </j:choose>
			</j:if>
		</j:forEach>

		<ant:copy todir="${maven.dist.bin.assembly.dir}/src/">
            <fileset dir="src/">
                <include name="**/*"/>
            </fileset>
        </ant:copy>
        <ant:copy todir="${maven.dist.bin.assembly.dir}/xdocs">
            <fileset dir="xdocs">
                <include name="**/*"/>
            </fileset>
        </ant:copy>
        <ant:copy todir="${maven.dist.bin.assembly.dir}" file="project.xml" />
        <ant:copy todir="${maven.dist.bin.assembly.dir}" file="project.properties" />
        <ant:copy todir="${maven.dist.bin.assembly.dir}" file="maven.xml" />
        <ant:copy todir="${maven.dist.bin.assembly.dir}" file="build.xml" />
        <ant:copy todir="${maven.dist.bin.assembly.dir}" file="LICENSE.txt" />
    </postGoal>
</project>